{
'id': 'bugs.core_2017',
'qmid': None,
'tracker_id': 'CORE-2017',
'title': 'I/O statistics for stored procedures are not accounted in monitoring tables',
'description':
 """
    We open TWO cursors within the same attachments and:
    1) make query to procedure inside cursor-1 (trivial count from table there);
    2) ask MON$ tables inside cur-2 with aquiring IO statistics (fetches) for cur-1 statement.
    Number of fetches should be not less then 202400 - see results for 2.1.x, 2.5.x and 3.0 below.
 """,
'min_versions': '2.1.0',
'versions': [
{
 'firebird_version': '2.1',
 'platform': 'All',
 'page_size': '4096',
 'init_script': """
    create table T (C integer);
    commit;

    set term ^ ;

    execute block
    as
    declare i int = 0;
    begin
      while (i < 100000) do
      begin
        insert into T values (:i);
        i = i + 1;
      end
    end ^
    commit ^

    create procedure sp_test
    returns (i bigint)
    as
    begin
     select count(*)
     from T
     into :i;
     suspend;
    end ^

    commit ^
  """,
 'test_type': 'Python',
 'test_script': """\
stt1 = db_conn.cursor()
stt2 = db_conn.cursor()

sp_query = "select * from sp_test"
stt2.execute(sp_query)
for row in stt2:
  pass

# do NOT!! >>> con1.commit()

sql_io='''
select 
   -- i.mon$page_fetches
   --,m.mon$sql_text 
   --,rdb$get_context('SYSTEM','ENGINE_VERSION')
   iif( i.mon$page_fetches > 202400, 'IO statistics for procedure is OK', 'Strange low value for fetches: ' || i.mon$page_fetches) fetches_result
from rdb$database r 
    left join mon$statements m on
        m.mon$sql_text containing '%s'
        and m.mon$sql_text NOT containing 'mon$statements'
    left join  mon$io_stats i on 
        m.mon$stat_id = i.mon$stat_id and i.mon$stat_group = 3
;
''' % sp_query
stt1.execute(sql_io)

for row in stt1:
  print(row[0])

# (0, 'select * from sp_test', '2.1.0')
# (0, 'select * from sp_test', '2.1.1')
# (202472, 'select * from sp_test', '2.1.2')
# (202472, 'select * from sp_test', '2.1.3')
# (202472, 'select * from sp_test', '2.1.7')
# (202472, 'select * from sp_test', '2.5.0')
# (202472, 'select * from sp_test', '2.5.1')
# (202472, 'select * from sp_test', '2.5.2')
# (202472, 'select * from sp_test', '2.5.3')
# (202472, 'select * from sp_test', '3.0.0')
# (202472, 'select * from sp_test', '4.0.0')
""",
 'expected_stdout': 
  """
    IO statistics for procedure is OK
  """
}
]
}
