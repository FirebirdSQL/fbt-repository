{
'id': 'bugs.core_4374',
'qmid': None,
'tracker_id': 'CORE-4374',
'title': 'Truncation error when using EXECUTE STATEMENT with a blob',
'description': '',
'min_versions': '3.0',
'versions': [
{
 'firebird_version': '3.0',
 'platform': 'All',
 'page_size': '4096',
 'test_type': 'ISQL',
 'init_script': 
  """
  """,
 'test_script': 
  """
    set list on;

    set term ^;
    execute block returns (SQL blob sub_type text) as
      declare single_sttm varchar(10);
      declare sn int = 32760;
      declare big_block_for_incr varchar(32760);
      declare max_length_for_big_blocks int = 1048576;
      declare small_incr_amount int = 2674; -- detected maximum for 3.0 Beta2 (WI-T3.0.0.31807)
    begin
      sql = 'create or alter procedure test_proc returns(id integer) as '||ascii_char(10)||'begin ';
      max_length_for_big_blocks = max_length_for_big_blocks - char_length(sql || 'end');
    
      single_sttm = 'suspend;' || ascii_char(10);
      big_block_for_incr = rpad('', trunc( sn / char_length(single_sttm) ) * char_length(single_sttm), single_sttm);
    
      while (max_length_for_big_blocks > sn) do
      begin
        sql = sql || big_block_for_incr;
        max_length_for_big_blocks = max_length_for_big_blocks - char_length(big_block_for_incr);
      end
    
      sql = sql || rpad('', small_incr_amount * char_length(single_sttm), single_sttm);
      sql = sql ||'end';
    
      execute statement :SQL; -- length of this blob will be more than 1 Mb
      
      -- Result for small_incr_amount int = 2674: 
      -- created SP will have total char_length of SRC = 1072395 and BLR = 3217215.
      -- select count(*) from this SP should return 119154 rows.
    end 
    ^
    set term ;^
    commit;
    
    set term ^;
    execute block returns(cnt int) as
      declare v_proc_src blob;
    begin
      execute statement 'select count(*) cnt from test_proc' into cnt;
      suspend;
    
      --select octet_length(rdb$procedure_source) from rdb$procedures where rdb$procedure_name = upper('test_proc')
      --into cnt;
      --suspend;
      --select octet_length(rdb$procedure_blr) from rdb$procedures where rdb$procedure_name = upper('test_proc')
      --into cnt;
      --suspend;
    
    end
    ^
    set term ;^
    commit;
  """,
 'expected_stdout':
  """
    CNT                             119154
  """
}
]
}
