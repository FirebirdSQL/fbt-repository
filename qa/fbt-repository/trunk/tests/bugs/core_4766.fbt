{
'id': 'bugs.core_4766',
'qmid': None,
'tracker_id': 'CORE-4766',
'title': 'AV when trying to manage users list using EXECUTE STATEMENT on behalf of non-sysdba user which has RDB$ADMIN role',
'description': '',
'min_versions': '3.0',
'versions': [
{
 'firebird_version': '3.0',
 'platform': 'All',
 'sql_dialect': 1,
 'test_type': 'ISQL',
 'init_script':
  """
  """,
 'test_script':
  """
    -- Note-1. Name of table in STDERR depends on value of UserManager = { Srp | Legacy_UserManager }.
    -- For 'Srp' it will be 'PLG$SRP_VIEW', for Legacy_UserManager -- PLG$VIEW_USERS.
    -- Because of this, section 'substitution' has been added in order to ignore rest part of line
    -- after words 'TABLE PLG'.

    -- Note-2. User 'boss' is NOT granted with 'RDB$ADMIN' role, only clause "grant admin" present for him
    -- in the creating statement, so all his attempts to create/drop another user will be FAILED.
    -- Before snapshot 31807 3rd such fail lead FB to crash (AV).

    -- Note-3. Since 3.0.0.32294 (was built 26-jan-2016) text of error message was chenged
    -- See also: http://sourceforge.net/p/firebird/code/62852 (24-jan-2016)

    create or alter user boss password '123' grant admin role;
    commit;
    
    set term ^;
    execute block as
    begin
        execute statement 'create or alter user mgr1 password ''456'''
        as user 'BOSS' password '123' role 'RDB$ADMIN';
    end
    ^
    set term ;^
    commit; -- this lead to first "SQLSTATE = 28000 / -no permission for INSERT access to TABLE PLG$VIEW_USERS"

    ROLLBACK; -- [###NB###] Added 01-apr-2016; explanation see in letter by dimitr, 31-mar-2016 17:23

    set term ^;
    execute block as
    begin
        execute statement 'drop user mgr1'
        as user 'BOSS' password '123' role 'RDB$ADMIN';
    end  
    -- This lead to 2nd "SQLSTATE = 28000" with text:
    -- before build 32136: "add record error / -no permission for INSERT access to TABLE PLG$VIEW_USERS"
    -- since  that  build: "find/delete record error / -no permission for DELETE access to TABLE"
    ^
    set term ;^
    
    -- Attention: see above ROLLBACK labaled as [###NB###]: without that rollback following
    -- COMMIT will again try to ADD user boss/123 and only after it - drop user statement,
    -- and this will lead to fail again with error about adding (not deleting) user.
    -- Explanation see in letter by dimitr, 31-mar-2016 17:23

    commit; -- this lead to FB crash and message about AV apperaed in firebird.log (checked on WI-T3.0.0.31801)

    rollback;

    drop user boss;
    commit; 
  """,
  'expected_stderr':
  """
    Statement failed, SQLSTATE = 28000
    add record error
    -no permission for INSERT access to TABLE PLG
    Statement failed, SQLSTATE = 28000
    find/delete record error
    -no permission for DELETE access to TABLE PLG
  """,
  'substitutions':[('TABLE PLG\$VIEW_USERS','TABLE PLG'), ('TABLE PLG\$SRP_VIEW', 'TABLE PLG') ]
}
]
}
