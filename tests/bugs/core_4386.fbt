{
'id': 'bugs.core_4386',
'qmid': None,
'tracker_id': 'CORE-4386',
'title': 'Report more details for "object in use" errors',
'description': 
 """
 """,
'min_versions': '3.0.6',
'versions': [
{
 'firebird_version': '3.0',
 'platform': 'All',
 'init_script': 
  """
  """,
 'test_type': 'Python',
 'test_script':"""\
import os
import subprocess

os.environ["ISC_USER"] = user_name
os.environ["ISC_PASSWORD"] = user_password
db_conn.close()

CUSTOM_TX_PARAMS = ( [ fdb.isc_tpb_read_committed, fdb.isc_tpb_no_rec_version, fdb.isc_tpb_nowait ] )

sql_ddl=\
'''
    set bail on;
    create or alter procedure sp_worker as begin end;
    create or alter procedure sp_test as begin end;
    create or alter view v_test as select 1 x from rdb$database;
    commit;

    recreate table test1(id int,x int);
    recreate table test2(id int,x int);
    commit;

    create index test1_id on test1(id);
    commit;
    create descending index test2_id_x_desc on test2(id,x);
    commit;

    create or alter view v_test as select id,x from test1 where id between 15 and 30;
    commit;

    set term ^;
    create or alter procedure sp_worker(a_id int) returns(x int) as
    begin
      for 
          execute statement ('select v.x from v_test v where v.id = ? and exists(select * from test2 b where b.id = v.id)') (:a_id)
          into x 
      do 
          suspend;
    end
    ^
    create or alter procedure sp_test(a_id int) returns(x int) as
    begin
      for 
          execute statement ('select x from sp_worker(?)') (:a_id)
          into x 
      do 
          suspend;
    end
    ^
    set term ;^
    commit;

    insert into test1 values(11,111);
    insert into test1 values(21,222);
    insert into test1 values(31,333);
    insert into test1 values(41,444);
    commit;

    insert into test2 select * from test1;
    commit;
'''

runProgram('isql', [ dsn ], sql_ddl)

con1=fdb.connect(dsn = dsn)
cur1=con1.cursor()
cur1.execute('select x from sp_test(21)')
for r in cur1:
    pass

drop_commands = [
    'drop procedure sp_test',
    'drop procedure sp_worker',
    'drop view v_test',
    'drop table test2',
    'drop index test1_id',
    'drop index test2_id_x_desc'
]

for i,c in enumerate(drop_commands):
    try:
        con2=fdb.connect(dsn = DB_NAME)
        tx = con2.trans( default_tpb = CUSTOM_TX_PARAMS )
        #############################################
        # READ COMMITTED | NO_RECORD_VERSION | NOWAIT
        #############################################
        tx.begin()
        cur2=tx.cursor()

        cur2.execute( c )

        tx.commit()
    except Exception as e:
        print('\nError when attempt to run "'+ c.strip().upper() + '":')
        print(e)
    finally:
        if cur2:
            cur2.close()
        if con2:
            con2.close()

cur1.close()
con1.close()

  """,
 'expected_stdout':
  """
  """,
 'expected_stderr':
  """
  """
}
]
}
