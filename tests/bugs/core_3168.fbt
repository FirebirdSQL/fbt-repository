{
'id': 'bugs.core_3168',
'qmid': None,
'tracker_id': 'CORE-3168',
'title': "exclude_filter doesn't work for <services></section> section of the Trace facility",
'description': """###   W A R N I N G   ###
1) This test uses async. calls of external routine (fbsvcmgr) with opening it in separate command window,
   see: subprocess.call('start /min cmd /c ...', shell=True).
2) It was encountered that launching trace session by FBSVCMGR requires 1-2 seconds to be finished,
   so this test intentionally uses delay (see calls `time.sleep()`).
3) Format of `database` section differ in 2.5 vs 3.0, so two separate sections have been created here for each FB version.
4) Correct work was checked on: WI-V2.5.5.26914 (SS, SC) and  WI-V3.0.0.31940 (SS, SC and CS).
""",
'min_versions': '2.5.0',
'versions': [
{
 'firebird_version': '2.5',
 'platform': 'Windows',
 'test_type': 'Python',
 'init_script':
  """
  """,
 'test_script':
  """import os
import subprocess
import time

db_conn.close()
# format in 3.0 differ: database=%[\\\\\\\\/]bugs.core_3168.fdb
txt = '''# Generated auto, do not edit!
<database %[\\\\\\\\/]bugs.core_3168.fdb>
  enabled = true
  time_threshold = 0
  exclude_filter %Trace%
  log_statement_prepare true
  log_statement_start true
  log_statement_finish true
</database>
'''
trccfg=open( os.path.join(context['temp_directory'],'tmp_trace_3168.cfg'), 'w')
trccfg.write(txt)
trccfg.close()
trclog=open( os.path.join(context['temp_directory'],'tmp_trace_3168.log'), 'w')
trclog.close()
trclst=open( os.path.join(context['temp_directory'],'tmp_trace_3168.lst'), 'w')
trclst.close()

trc_launch='"fbsvcmgr localhost:service_mgr user SYSDBA password masterkey action_trace_start trc_cfg %s 1>%s 2>&1"' % (trccfg.name, trclog.name )

# Launch program in separate (new) window via START command:
subprocess.call('start /min cmd /c %s' % trc_launch, shell=True)
time.sleep(2)

sqltxt='''
set list on;
select 1 c from rdb$database where 'Start Trace Session' similar to '%Trace%';
'''

runProgram('isql',[dsn,'-user',user_name,'-pas',user_password],sqltxt)

# Wait! Trace session is initialized not instantly!
time.sleep(2)

# Save active trace session info into file for further parsing it and obtain session_id back (for stop):
svc_launch='"fbsvcmgr localhost:service_mgr user SYSDBA password masterkey action_trace_list 1>%s 2>&1"' % trclst.name
subprocess.call('cmd /c %s' % svc_launch)

trcssn=0
with open( trclst.name,'r') as f:
    for line in f:
        i=1
        if 'Session ID' in line:
            for word in line.split():
                if i==3:
                    trcssn=word
                i=i+1
            break

# Result: `trcssn` is ID of active trace session. Now we have to terminate it:
runProgram('fbsvcmgr', ['localhost:service_mgr','user','SYSDBA','password','masterkey','action_trace_stop','trc_id',trcssn])

time.sleep(1)

# Repeat: check that this trace session really have been terminated:
runProgram('fbsvcmgr', ['localhost:service_mgr','user','SYSDBA','password','masterkey','action_trace_list'])

# Output log of trace for comparing it with expected: it must contain only TWO events: TRACE_INIT and TRACE_FINI
with open( trclog.name,'r') as f:
    print(f.read())
f.close()

if os.path.isfile(trccfg.name):
    os.remove(trccfg.name)
if os.path.isfile(trclst.name):
    os.remove(trclst.name)
if os.path.isfile(trclog.name):
    os.remove(trclog.name)
  """,
 'expected_stdout': 
  """
    TRACE_INIT
    TRACE_FINI
  """,
 'expected_stderr': 
  """
  """,
  'substitutions': [('^((?!Error|error|element|TRACE_INIT|PREPARE_STATEMENT|EXECUTE_STATEMENT_START|EXECUTE_STATEMENT_FINISH|TRACE_FINI).)*$',''),
      ('.*TRACE_INIT','TRACE_INIT'),
      ('.*TRACE_FINI','TRACE_FINI')
  ]
},
{
 'firebird_version': '3.0',
 'platform': 'Windows',
 'test_type': 'Python',
 'init_script':
  """
  """,
 'test_script':
  """import os
import subprocess
import time

db_conn.close()

# ### NOTES ABOUT TRACE CONFIG FOR 3.0 ###
# 1) Header contains `database` clause in different format vs FB 2.5.
# 2) Name and value must be separated by EQUALITY sign ('=') in FB-3 trace.conf, otherwise we get runtime error:
#    element "<. . .>" have no attribute value set

txt = '''# Generated auto, do not edit!
database=%[\\\\\\\\/]bugs.core_3168.fdb
{
  enabled = true
  time_threshold = 0
  exclude_filter = %Trace%
  log_statement_prepare = true
  log_statement_start = true
  log_statement_finish = true
}
'''
trccfg=open( os.path.join(context['temp_directory'],'tmp_trace_3168.cfg'), 'w')
trccfg.write(txt)
trccfg.close()
trclog=open( os.path.join(context['temp_directory'],'tmp_trace_3168.log'), 'w')
trclog.close()
trclst=open( os.path.join(context['temp_directory'],'tmp_trace_3168.lst'), 'w')
trclst.close()

trc_launch='"fbsvcmgr localhost:service_mgr user SYSDBA password masterkey action_trace_start trc_cfg %s 1>%s 2>&1"' % (trccfg.name, trclog.name )

# Launch program in separate (new) window via START command:
subprocess.call('start /min cmd /c %s' % trc_launch, shell=True)
time.sleep(2)

sqltxt='''
set list on;
select 1 c from rdb$database where 'Start Trace Session' similar to '%Trace%';
'''

runProgram('isql',[dsn,'-user',user_name,'-pas',user_password],sqltxt)

# Wait! Trace session is initialized not instantly!
time.sleep(2)

# Save active trace session info into file for further parsing it and obtain session_id back (for stop):
svc_launch='"fbsvcmgr localhost:service_mgr user SYSDBA password masterkey action_trace_list 1>%s 2>&1"' % trclst.name
subprocess.call('cmd /c %s' % svc_launch)

trcssn=0
with open( trclst.name,'r') as f:
    for line in f:
        i=1
        if 'Session ID' in line:
            for word in line.split():
                if i==3:
                    trcssn=word
                i=i+1
            break

# Result: `trcssn` is ID of active trace session. Now we have to terminate it:
runProgram('fbsvcmgr', ['localhost:service_mgr','user','SYSDBA','password','masterkey','action_trace_stop','trc_id',trcssn])

time.sleep(1)

# Repeat: check that this trace session really have been terminated:
runProgram('fbsvcmgr', ['localhost:service_mgr','user','SYSDBA','password','masterkey','action_trace_list'])

# Output log of trace for comparing it with expected: it must contain only TWO events: TRACE_INIT and TRACE_FINI
with open( trclog.name,'r') as f:
    print(f.read())
f.close()

if os.path.isfile(trccfg.name):
    os.remove(trccfg.name)
if os.path.isfile(trclst.name):
    os.remove(trclst.name)
if os.path.isfile(trclog.name):
    os.remove(trclog.name)
  """,
 'expected_stdout': 
  """
    TRACE_INIT
    TRACE_FINI
  """,
 'expected_stderr': 
  """
  """,
  'substitutions': [('^((?!Error|error|element|TRACE_INIT|PREPARE_STATEMENT|EXECUTE_STATEMENT_START|EXECUTE_STATEMENT_FINISH|TRACE_FINI).)*$',''),
      ('.*TRACE_INIT','TRACE_INIT'),
      ('.*TRACE_FINI','TRACE_FINI')
  ]
}
]
}
