{
'id': 'bugs.core_6208',
'qmid': None,
'tracker_id': 'CORE-6208',
'title': 'Grant lost in security.db after backup/restore cycle',
'description': 
 """
    Ticket shows scenario with local protocol which allows security.db to be overwritten.
    This can not be done when we work using remote protocol, but we can exploit ability
    to change security DB. This is done by specifying parameter SecurityDatabase in databases.conf
    and its value is equal to alias of test database that we use:
        tmp_6208 = <path__and_name_of_test_database> {
            SecurityDatabase = tmp_6208
        }
    
    Test DB is named here 'fdb_init' and it is created by file copy of $FB_HOME\securityN.db
    Then file 'databases.conf' as adjusted so that SecurityDatabase will point to this test DB.
    After this we can connect to $fdb_ini, create user (his name: 'TMP6208DBA') and give him 
    privilege to create database.

    Futher, we make backup of this test DB and restore it. New database name is 'fdb_rest'.
    After this, we change state of test DB to full shutdown and overwrite it by $fdb_rest.
    Finaly, we make connection to this DB (that was just overwritten) and check that output
    of 'show grants' command contains:

        GRANT CREATE DATABASE TO USER TMP6208DBA

    Confirmed lost of grant on 4.0.0.1691 (build 14-dec-2019).

    26.08.2020.
    IT CRUSIAL FOR THIS TEST DO MAKE ALL RESTORE AND FURTHER ACTIONS IN LOCAL/EMBEDDED PROTOCOL.
    Discissed with Alex, see letter 24.08.2020 19:49.

    Main problem is in SuperClassic: after restore finish, we can not connect to this DB by TCP,
    error is
        "Statement failed, SQLSTATE = 08006 / Error occurred during login, please check server firebird.log for details"
    Server log contains in this case: "Srp Server / connection shutdown / Database is shutdown."

    Checked initially on 4.0.0.1712 SC: 11s, 4.0.0.1714 SS, CS (7s, 16s).
    Checked again 26.08.2020 on 4.0.0.2173 SS/CS/SC.
 """,
'min_versions': '4.0',
'versions': [
{
 'firebird_version': '4.0',
 'platform': 'All',
 'test_type': 'Python',
 'test_script': """
import os
import sys
import time
import subprocess
import shutil
from subprocess import PIPE
from fdb import services

os.environ["ISC_USER"] = user_name
os.environ["ISC_PASSWORD"] = user_password

#--------------------------------------------

def svc_get_fb_log( fb_home, f_fb_log ):

  global subprocess
  subprocess.call( [ fb_home + "fbsvcmgr",
                     "localhost:service_mgr",
                     "action_get_fb_log"
                   ],
                   stdout=f_fb_log, stderr=subprocess.STDOUT
                 )
  return

#--------------------------------------------
def cleanup( f_names_list ):
    global os
    for i in range(len( f_names_list )):
       if os.path.isfile( f_names_list[i]):
            os.remove( f_names_list[i] )
#--------------------------------------------

fb_home = services.connect(host='localhost', user= user_name, password= user_password).get_home_directory()
this_db = db_conn.database_name
fb_vers = str(db_conn.engine_version)[:1] # character for security.db file: engine = 4.0  --> '4'
sec_db = fb_home + 'security' + fb_vers+ '.fdb'
db_conn.close()

fdb_init = os.path.join(context['temp_directory'],'tmp_6208_initial.fdb')
fdb_bkup = os.path.join(context['temp_directory'],'tmp_6208_initial.fbk')
fdb_rest = os.path.join(context['temp_directory'],'tmp_6208_restored.fdb')

cleanup( (fdb_init, fdb_rest) )

shutil.copy2( sec_db, fdb_init )

# Resut: fb_home is full path to FB instance home (with trailing slash).
shutil.copy2( fb_home+'databases.conf', fb_home+'databases.bak' )

alias_data=\
'''
    # Added temporarily for executing test core_6208.fbt
    tmp_6208 = %(fdb_init)s {
        # RemoteAccess = true
        SecurityDatabase = tmp_6208
    }
''' % locals()

f_dbconf=open(fb_home+'databases.conf','a', buffering = 0)
f_dbconf.seek(0, 2)
f_dbconf.write(alias_data)
f_dbconf.close()

sql_init=\
'''
    set bail on;
    create or alter user tmp6208dba password '123' using plugin Srp;
    grant create database to user tmp6208dba;
    alter database set linger to 0;
    commit;
'''
runProgram('isql',[ fdb_init ], sql_init)

#########################################################################

f_backup_log = open( os.path.join(context['temp_directory'],'tmp_6208.backup.log'), 'w', buffering = 0)
f_backup_err = open( ''.join( (os.path.splitext(f_backup_log.name)[0], '.err' ) ), 'w', buffering = 0)

subprocess.call( [ os.path.join( fb_home, 'gfix'), '-h', '54321', fdb_init ], stdout = f_backup_log, stderr = f_backup_err)
subprocess.call( [ os.path.join( fb_home, 'gstat'), '-h', fdb_init ], stdout = f_backup_log, stderr = f_backup_err)
subprocess.call( [ os.path.join( fb_home, 'gbak'), '-b', fdb_init, fdb_bkup, '-v', '-st', 'tdrw' ], stdout = f_backup_log, stderr = f_backup_err)

f_backup_log.close()
f_backup_err.close()

########################################################################

cleanup( (fdb_rest,) )

f_restore_log = open( os.path.join(context['temp_directory'],'tmp_6208.restore.log'), 'w', buffering = 0)
f_restore_err = open( ''.join( (os.path.splitext(f_restore_log.name)[0], '.err' ) ), 'w', buffering = 0)

subprocess.call( [ os.path.join( fb_home, 'gbak'), '-c', fdb_bkup, fdb_rest, '-v', '-st', 'tdrw' ], stdout = f_restore_log, stderr = f_restore_err)

f_restore_log.close()
f_restore_err.close()

########################################################################


runProgram('gfix',['-shut', 'full', '-force', '0', fdb_init] )
runProgram('gfix',['-shut', 'full', '-force', '0', fdb_rest] )

shutil.move( fdb_rest, fdb_init )

runProgram('gfix',['-online', fdb_init] )

###############
#time.sleep(8.5)
###############

sql_chk=\
'''
    set bail on;
    set list on;
    -- set echo on;
	-- ##########################
    -- SuperClassic:
    -- Statement failed, SQLSTATE = 08006
    -- Error occurred during login, please check server firebird.log for details
    -- firebird.log:
	-- Srp Server
	-- connection shutdown
	-- Database is shutdown.
	-- ##########################
    -- connect 'localhost:%(fdb_init)s' user tmp6208dba password '123';
    connect '%(fdb_init)s' user tmp6208dba password '123';
    select
         d.mon$owner as "mon$database.mon$owner"
        ,d.mon$sec_database as "mon$database.mon$sec_database"
        ,r.rdb$linger as "rdb$database.rdb$linger"
        --,a.mon$remote_protocol as "mon$attachments.mon$remote_protocol"
        ,current_user as whoami
    from mon$database d
    join mon$attachments a on a.mon$attachment_id = current_connection
    cross join rdb$database r

    ;

    select
        s.sec$user_name as "sec$users.sec_user"
       ,c.sec$user_type as "sec$db_creators.sec$user_type"
    from sec$users s
    left join sec$db_creators c on s.sec$user_name = c.sec$user
    where sec$user_name = upper('TMP6208DBA');
    rollback;

    connect '%(fdb_init)s';
    drop user tmp6208dba using plugin Srp;
    commit;
''' % locals()

f_chk_sql = open( os.path.join(context['temp_directory'],'tmp_6208_chk.sql'), 'w', buffering = 0)
f_chk_sql.write(sql_chk)
f_chk_sql.close()

# 4debug only:
#f_gstat_log = open( os.path.join(context['temp_directory'],'tmp_6208_gstat.log'), 'w', buffering = 0)
#subprocess.call( ["gstat", "-h", fdb_init ], stdout = f_gstat_log, stderr = subprocess.STDOUT)
#f_gstat_log.close()

f_chk_log = open( os.path.join(context['temp_directory'],'tmp_6208_chk.log'), 'w', buffering = 0)
subprocess.call( ["isql", "-q", "-i", f_chk_sql.name ], stdout = f_chk_log, stderr = subprocess.STDOUT)
f_chk_log.close()

#######runProgram('isql',[ fdb_init ], 'drop user tmp6208dba using plugin Srp; commit;')

f_shut_log = open( os.path.join(context['temp_directory'],'tmp_6208_shut.log'), 'w', buffering = 0)
subprocess.call( ["gfix", "-shut", "full", "-force", "0",  fdb_init ], stdout = f_shut_log, stderr = subprocess.STDOUT)
subprocess.call( ["gstat", "-h", fdb_init ], stdout = f_shut_log, stderr = subprocess.STDOUT)
f_shut_log.close()


# Restore previous content:
shutil.copy2( fb_home+'databases.bak', fb_home+'databases.conf' )

with open(f_chk_log.name,'r') as f:
   for line in f:
      print(line)


# cleanup:
##########
time.sleep(1)
cleanup( [x.name for x in (f_backup_log, f_backup_err, f_restore_log, f_restore_err, f_chk_sql, f_chk_log, f_shut_log) ] + [ fdb_init, fdb_bkup, fb_home+'databases.bak' ] )

""",
 'expected_stdout': 
  """
    mon$database.mon$owner          SYSDBA
    mon$database.mon$sec_database   Self
    rdb$database.rdb$linger         0
    WHOAMI                          TMP6208DBA
    sec$users.sec_user              TMP6208DBA
    sec$db_creators.sec$user_type   8
  """,
 'expected_stderr': 
  """
  """,
  'substitutions':[ ('\t+', ' ') ]
}
]
}
