{
'id': 'bugs.core_4852',
'qmid': '',
'tracker_id': 'CORE-4852',
'title': 'Within linger period one can not change some database properties',
'description': 'Confirmed on WI-T3.0.0.31374 Beta 1: running GFIX -buffers N has NO affect if this is done within linger period',
'min_versions': '3.0',
'versions': [
{
 'firebird_version': '3.0',
 'platform': 'All',
 'init_script':
  """
    -- Result of this test on WI-T3.0.0.31374 Beta 1:
    -- Expected standard output from Python does not match actual output.
    -- - GFIX could change buffers ? =>  YES
    -- ?                                 ^^^
    -- + GFIX could change buffers ? =>  NO!
    -- ?                                 ^^^

    set term ^;
    -- Aux procedure that determines: is current connection to SuperServer ?
    -- If yes, returns current value of page buffers, otherwise (SC/CS) always return -1, in order to
    -- make final output = 'N/A' and give 'substitutions' section handle this case as acceptable.
    create or alter procedure sp_get_buff returns(mon_buffers int) as
    begin
        mon_buffers = -1;
        if ( exists(  select * from mon$attachments where mon$user containing 'cache writer' and mon$system_flag = 1 ) )
        then
            select mon$page_buffers from mon$database into mon_buffers;
        
        suspend;

    end
    ^
    set term ;^
    commit;
    recreate table log(buf_before int, buf_after int);
    commit;
  """,
 'test_type': 'Python',
 'test_script': """script = '''
    insert into log(buf_before) select mon_buffers from sp_get_buff;
    commit;
    alter database set linger to 5; 
    commit;
    set list on;
    select rdb$linger as ":::MSG::: linger_time" from rdb$database;
'''
print (':::MSG::: Starting ISQL setting new value for linger...')
runProgram('isql',[dsn,'-user',user_name,'-password',user_password],script)
print (':::MSG::: ISQL setting new value for linger finished.')
db_conn.close()
print (':::MSG::: Starting GFIX setting new value for page buffers...')
runProgram('gfix',[dsn,'-user',user_name,'-pas',user_password,'-buffers','3791'])
runProgram('gfix',[dsn,'-user',user_name,'-pas',user_password,'-w','async'])
runProgram('gfix',[dsn,'-user',user_name,'-pas',user_password,'-mode','read_only'])
runProgram('gfix',[dsn,'-user',user_name,'-pas',user_password,'-sh','single', '-at', '20'])
runProgram('gstat',['-h','-user',user_name,'-pas',user_password,dsn])
runProgram('gfix',[dsn,'-user',user_name,'-pas',user_password,'-online'])
runProgram('gfix',[dsn,'-user',user_name,'-pas',user_password,'-mode','read_write'])
print (':::MSG::: GFIX setting new value for page buffers finished.')
print (':::MSG::: Starting ISQL for extract old and new value of page buffers...')
script='''
    set list on; 
    update log set buf_after = (select mon_buffers from sp_get_buff);
    commit;
    select iif( g.buf_before > 0, 
                iif( g.buf_before is distinct from g.buf_after, 'YES', 'NO!' ), 
                'N/A' 
              ) as "GFIX could change buffers ? =>"
    from log g;
'''
runProgram('isql',[dsn,'-user',user_name,'-password',user_password],script)
print (':::MSG::: ISQL for extract old and new value of page finished.')
  """,
 'expected_stdout': 
  """
    :::MSG::: Starting ISQL setting new value for linger...
    :::MSG::: linger_time           5
    :::MSG::: ISQL setting new value for linger finished.
    :::MSG::: Starting GFIX setting new value for page buffers...
    Page buffers 3791
    Attributes single-user maintenance, read only
    :::MSG::: GFIX setting new value for page buffers finished.
    :::MSG::: Starting ISQL for extract old and new value of page buffers...
    GFIX could change buffers ? =>  YES
    :::MSG::: ISQL for extract old and new value of page finished.
  """,
  'substitutions':[
    ('^((?!:::MSG:::|buffers|before|after|Attributes).)*$',''),
    ('Page buffers([\t]|[ ])+','Page buffers '),
    ('Attributes([\t]|[ ])+','Attributes '),
    ('N/A', 'YES')
  ]
},
]
}
