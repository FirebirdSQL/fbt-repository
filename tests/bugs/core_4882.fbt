{
'id': 'bugs.core_4882',
'qmid': '',
'tracker_id': 'CORE-4882',
'title': "ISQL input command (or -i option) reads large (> 64K) lines incorrectly",
'description': """This test verifies ability of parsing multiple statements that are going as `single-lined stream`.
Source for this test is file `fbt-repo\files\core_4882.sql`.

1) Lines NN 1...4 in this file are used verify parsing of very long execute block (SINGLE statement) with hundreds and thousands 
   of nested begin/end blocks. In the most nested block user-defined exception which is given depth level. 
   Each of these lines could not be compiled up to WI-V3.0.0.31948, raising:
   ===
   Statement failed, SQLSTATE = 42000
   Dynamic SQL Error
   -SQL error code = -104
  -Token unknown - line 2, column 1
   -d
  ===
   No error on prepare and running should occur since buiild WI-V3.0.0.31981. 

2) Line 5 is almost all source code of test that emulates OLTP workload - without initial script for data filling.
   This test can be found here: svn://svn.code.sf.net/p/firebird/code/qa/oltp-emul/
   Three files were taken from it: oltp30_DDL.sql, oltp30_sp.sql and oltp_main_filling.sql - with total size  ~600 Kb.
   Then all single-lined comments ("-- blah blah ...") were removed and remained source code was pulled out in single-line.
   This single-line also could not be compiled up to WI-V3.0.0.31948, raising 'token unknown'.
   No error on compiling should occur since buiild WI-V3.0.0.31981. 
""",
'min_versions': '3.0',
'versions': [
{
 'firebird_version': '3.0',
 'platform': 'All',
 'page_size': '4096',
 'test_type': 'Python',
 'test_script': '''\
import os

db_conn.close()
scriptfile=open(os.path.join(context['files_location'],'core_4882.sql'),'r')
scriptfile.close()
runProgram('isql',[dsn,'-user',user_name,'-pas',user_password,'-i',scriptfile.name])
''',
 'expected_stdout': 
  """
    MSG                             oltp30_DDL.sql start
    MSG                             oltp30_DDL.sql finish
    MSG                             oltp30_sp.sql start
    MSG                             oltp30_sp.sql finish
    MSG                             oltp_main_filling.sql start
    MSG                             oltp_main_filling.sql finish
  """,
 'expected_stderr': 
  """
    Statement failed, SQLSTATE = HY000
    exception 10
    -EX_TEST
    -Hi from Mariana Trench, depth=2513

    Statement failed, SQLSTATE = HY000
    exception 11
    -EX_TEST
    -Hi from Mariana Trench, depth=993

    Statement failed, SQLSTATE = HY000
    exception 12
    -EX_TEST
    -Hi from Mariana Trench, depth=630 => "zero thousand(s) + six hundred(s) + three decade(s) + zero unit(s)"

    Statement failed, SQLSTATE = HY000
    exception 13
    -EX_TEST
    -Hi from Mariana Trench, depth=641 => "zero thousand(s) + six hundred(s) + four decade(s) + one unit(s)"
  """,
  'substitutions':[ ('exception [0-9]+','exception'), ('After line [0-9]+ in file.*', ''), ('CURRENT_TIMESTAMP.*', '') ]
}
]
}
