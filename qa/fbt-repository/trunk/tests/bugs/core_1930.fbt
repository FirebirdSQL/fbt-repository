{
'id': 'bugs.core_1930',
'qmid': None,
'tracker_id': 'CORE-1930',
'title': 'Possible AV in engine if procedure was altered to have no outputs and dependent procedures was not recompiled',
'description': '',
'min_versions': '2.5.0',
'versions': [
{
 'firebird_version': '2.5',
 'platform': 'All',
 'page_size': '4096',
 'test_type': 'ISQL',
 'test_script': 
  """
    set term ^;
    create or alter procedure sp1 returns (x int) as
    begin
      x=1;
      suspend;
    end
    ^
    
    create or alter procedure sp2 returns (x int) as
    begin
      select x from sp1 into :x;
      suspend;
    end
    ^
    
    create or alter procedure sp3 returns (x int)  as
    begin
      select x from sp2 into :x;
      suspend;
    end
    ^
    
    commit
    ^
    
    
    -- this is wrong but engine still didn't track procedure's fields dependencies
    create or alter procedure sp1
    as
    begin
      exit;
    end
    ^
    
    set term ;^
    commit;
    
    -- Here we create new attachment using specification of some non-null data in ROLE clause:
    set term ^;
    execute block as
    begin
        execute statement 'create or alter procedure sp3 as begin  execute procedure sp2; end'
        on external 'localhost:' || rdb$get_context('SYSTEM', 'DB_NAME')
        as user 'sysdba' password 'masterkey' role 'R1930';
    end
    ^
    set term ;^
    commit;
  """,
 'expected_stderr':
  """
    Statement failed, SQLSTATE = 42000
    Execute statement error at isc_dsql_prepare :
    335544569 : Dynamic SQL Error
    335544850 : Output parameter mismatch for procedure SP2
    Statement : create or alter procedure sp3 as begin  execute procedure sp2; end
    Data source : Firebird::localhost:C:\MIX\FIREBIRD\QA\FBT-REPO\TMP\C1930.FDB
    -At block line: 3, col: 9
  """,
  'substitutions':[
      ('Data source : Firebird::localhost:.*','Data source : Firebird::localhost:'),
      ('-At block line: [\d]+, col: [\d]+', '-At block line')
   ]
},
{
 'firebird_version': '3.0',
 'platform': 'All',
 'page_size': '4096',
 'test_type': 'ISQL',
 'test_script': 
  """
    set term ^;
    create or alter procedure sp1 returns (x int) as
    begin
      x=1;
      suspend;
    end
    ^
    
    create or alter procedure sp2 returns (x int) as
    begin
      select x from sp1 into :x;
      suspend;
    end
    ^
    
    create or alter procedure sp3 returns (x int)  as
    begin
      select x from sp2 into :x;
      suspend;
    end
    ^
    
    commit
    ^
    
    
    -- this is wrong but engine still didn't track procedure's fields dependencies
    create or alter procedure sp1
    as
    begin
      exit;
    end
    ^
    
    set term ;^
    commit;
    
    -- Here we create new attachment using specification of some non-null data in ROLE clause:
    set term ^;
    execute block as
    begin
        execute statement 'create or alter procedure sp3 as begin  execute procedure sp2; end'
        on external 'localhost:' || rdb$get_context('SYSTEM', 'DB_NAME')
        as user 'sysdba' password 'masterkey' role 'R1930';
    end
    ^
    set term ;^
    commit;
  """,
 'expected_stderr':
  """
    Statement failed, SQLSTATE = 42000
    Execute statement error at isc_dsql_execute2 :
    335544351 : unsuccessful metadata update
    336397267 : CREATE OR ALTER PROCEDURE SP3 failed
    335544569 : Dynamic SQL Error
    335544850 : Output parameter mismatch for procedure SP2
    Statement : create or alter procedure sp3 as begin  execute procedure sp2; end
    Data source : Firebird::localhost:C:\MIX\FIREBIRD\QA\FBT-REPO\TMP\C1930.FDB
    -At block line: 3, col: 9
  """,
  'substitutions':[
      ('Data source : Firebird::localhost:.*','Data source : Firebird::localhost:'),
      ('-At block line: [\d]+, col: [\d]+', '-At block line')
   ]
}
]
}
