@echo off
setlocal enabledelayedexpansion enableextensions

@rem File name: C:\firebird\QA\fbt-repo\fbt-run.bat 
@rem It is recommended to put this file in the 'top-level' folder - "QA\fbt-repo".
@rem Running sample: C:\MIX\firebird\QA\fbt-repo\fbt-run.bat core_NNNN.fbt 
@rem Also it is convenient to 'bind' this batch to files with pattern *.fbt
@rem from sub-folder fbt-repo\tests\ (FAR: F10 / Commands / File associations)
@rem I that case one may always to sit in the folder with .fbt files
@rem (e.g. fbt-repo\tests\bugs\) and run all necessary tests only by pressing
@rem ENTER key on selected .fbt

cd >tmp.tmp.tmp
set /p curdir= < tmp.tmp.tmp
del tmp.tmp.tmp

set cdprefix=
set find_what=%~dp0
set repl_with=
for /f "tokens=* delims=\" %%a in ("%curdir%") do (
  set string=%%a
  set cdprefix=!string:%find_what%=%repl_with%!
  set cdprefix=!cdprefix:tests\=%repl_with%!
  set cdprefix=!cdprefix:\=.!
)

set fbt_name=%~n1
set fb25home=C:\MIX\firebird\fb25\bin
set fb25port=3050

set fb30sShome=C:\MIX\firebird\fb30
set fb30sChome=C:\MIX\firebird\fb30SC

set fb30sSport=3333
set fb30sCport=3330

@echo off
cd %~dp0

@rem results: 0=ok, 1=fault
set res25=0
set res30sS=0
set res30sC=0

set e25size=0
set err30sS=0
set err30sC=0

del fbt-run.25*.* 2>nul
del fbt-run.30*.* 2>nul

@rem if specified than ONLY this FB version will be checked: 25 30ss or 30sc
set fb_only=%2

if /i .%fb_only%.==.25. goto run25
if /i .%fb_only%.==.30sS. goto run30sS
if /i .%fb_only%.==.30sC. goto run30sC
goto run25

:run25
  echo %date%, %time%, running test: %fbt_name%>fbt-run.25.log
  echo ------------------------------------------------------->>fbt-run.25.log
  %fb25home%\fbsvcmgr localhost/%fb25port%:service_mgr user %isc_user% password %isc_password% info_server_version 1>>fbt-run.25.log 2>&1
  set fbt_run=fbt_run -b %fb25home% %cdprefix%.%fbt_name% -o localhost/%fb25port%

  set msg=Command: %fbt_run%
  echo.
  echo %msg%
  echo %msg%>>fbt-run.25.log

  cmd /c %fbt_run% 1>>fbt-run.25.log 2>fbt-run.25.err
  copy %~dp0results.trf fbt-run.25.trf 1>nul

  findstr /B /I "Nothing to run" fbt-run.25.log 1>nul 2>&1
  if errorlevel 1 goto chkr25
  set res25=1                       &:: .......... no sense to check on errors because of "Nothing to run"
  goto run30sS

:chkr25
  findstr /B /I "FAIL ERROR" fbt-run.25.log 1>nul 2>&1
  if errorlevel 1 (
     findstr /b /c:Ran fbt-run.25.log 1>nul 2>&1
     if errorlevel 1 set res25=1

     findstr /b /e /c:OK fbt-run.25.log 1>nul 2>&1
     if errorlevel 1 set res25=1

     if .!res25!.==.0. (
       echo FB 2.5: SUCCESS          &:: ............ test finished OK, continue next one .........
       if /i .%fb_only%.==.25. goto chk_err
       goto run30sS
     )
  )
  echo ### FB 2.5: FAILED ###
  set res25=1
  goto run30sS

:run30sS
  echo %date%, %time%, running test: %fbt_name%>fbt-run.30sS.log
  echo ------------------------------------------------------->>fbt-run.30sS.log
  %fb30sShome%\fbsvcmgr localhost/%fb30sSport%:service_mgr user %isc_user% password %isc_password% info_server_version 1>>fbt-run.30sS.log 2>&1
  echo.

  set fbt_run=fbt_run -b %fb30sShome% %cdprefix%.%fbt_name% -o localhost/%fb30sSport%
  set msg=Command: %fbt_run%
  echo %msg%
  echo %msg%>>fbt-run.30sS.log

  cmd /c %fbt_run% 1>>fbt-run.30sS.log 2>fbt-run.30sS.err
  copy %~dp0results.trf fbt-run.30sS.trf 1>nul

  findstr /B /I "Nothing to run" fbt-run.30sS.log 1>nul 2>&1
  if errorlevel 1 goto chkr30sS
  set res30sS=1                       &:: .......... no sense to check on errors because of "Nothing to run"
  goto run30sC


:chkr30sS
  findstr /B /I "FAIL ERROR" fbt-run.30sS.log 1>nul 2>&1
  if errorlevel 1 (
     findstr /b /c:Ran fbt-run.30sS.log 1>nul 2>&1
     if errorlevel 1 set res30sS=1

     findstr /b /e /c:OK fbt-run.30sS.log 1>nul 2>&1
     if errorlevel 1 set res30sS=1

     if .!res30sS!.==.0. (
       echo FB 3.0 SUPER: SUCCESS            &:: ............ test finished OK, continue next one .........
       if /i .%fb_only%.==.30sS. goto chk_err
       goto run30sC
     )
  )

  echo ### FB 3.0 SUPER: FAILED ###
  set res30sS=1
  goto run30sC


:run30sC
  echo %date%, %time%, running test: %fbt_name%>fbt-run.30sC.log
  echo ------------------------------------------------------->>fbt-run.30sC.log
  %fb30sChome%\fbsvcmgr localhost/%fb30sCport%:service_mgr user %isc_user% password %isc_password% info_server_version 1>>fbt-run.30sC.log 2>&1
  echo.

  set fbt_run=fbt_run -b %fb30sChome% %cdprefix%.%fbt_name% -o localhost/%fb30sCport%
  set msg=Command: %fbt_run%
  echo %msg%
  echo %msg%>>fbt-run.30sC.log

  cmd /c %fbt_run% 1>>fbt-run.30sC.log 2>fbt-run.30sC.err
  copy %~dp0results.trf fbt-run.30sC.trf 1>nul

  findstr /B /I "Nothing to run" fbt-run.30sC.log 1>nul 2>&1
  if errorlevel 1 goto chkr30sC
  set res30sC=1                       &:: .......... no sense to check on errors because of "Nothing to run"

  goto showlog

:chkr30sC
  findstr /B /I "FAIL ERROR" fbt-run.30sC.log 1>nul 2>&1
  if errorlevel 1 (
     findstr /b /c:Ran fbt-run.30sC.log 1>nul 2>&1
     if errorlevel 1 set res30sC=1

     findstr /b /e /c:OK fbt-run.30sC.log 1>nul 2>&1
     if errorlevel 1 set res30sC=1

     if .!res30sC!.==.0. (
       echo FB 3.0 CLASSIC: SUCCESS            &:: ............ test finished OK, continue next one .........
       if /i .%fb_only%.==.30sC. goto chk_err
       goto chk_err
     )
  )

  echo ### FB 3.0 CLASSIC: FAILED ###
  set res30sC=1
  goto chk_err                         &:: ::::::::::::::::  show log *AND* errors ::::::::::::::::::


@rem --- final check ---
:chk_err
  for /f "usebackq" %%A in ('fbt-run.25.err') do set e25size=%%~zA
  if .%e25size%.==.. set e25size=0
  if %e25size% gtr 0 (
   set res25=1
  )

  for /f "usebackq" %%A in ('fbt-run.30sS.err') do set err30sS=%%~zA
  if .%err30sS%.==.. set err30sS=0
  if %err30sS% gtr 0 (
    set res30sS=1
  )

  for /f "usebackq" %%A in ('fbt-run.30sC.err') do set err30sC=%%~zA
  if .%err30sC%.==.. set err30sC=0
  if %err30sC% gtr 0 (
    set res30sC=1
  )

:showlog

echo ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^| %fbt_name%, log25: start  ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|
type fbt-run.25.log
echo ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^| %fbt_name%, log25: finish ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|
echo.
echo ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^| %fbt_name%, log30 SUPER: start  ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|
type fbt-run.30sS.log
echo ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^| %fbt_name%, log30 SUPER: finish ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|
echo.
echo ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^| %fbt_name%, log30 CLASSIC: start  ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|
type fbt-run.30sC.log
echo ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^| %fbt_name%, log30 CLASSIC: finish ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|

set /a overall=%res25%+%res30sS%+%res30sC%
if .%overall%.==.0. (
  echo.
  echo ###  A L L    O K  ###
  del fbt-run.30*.err
  del fbt-run.30*.log
  del fbt-run.25.err
  del fbt-run.25.log
) else (
  if .%e25size%. gtr .0. (
    echo.
    echo ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^| %fbt_name%, err25: start  ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|
    type fbt-run.25.err
    echo ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^| %fbt_name%, err25: finish ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|
  ) else (
    del fbt-run.25.err
  )

  echo.

  if .%err30sS%. gtr .0. (
    echo.
    echo ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^| %fbt_name%, err30 SUPER: start  ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|
    type fbt-run.30sS.err
    echo ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^| %fbt_name%, err30 SUPER: finish ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|
  ) else (
    del fbt-run.30sS.err
  )

  echo.

  if .%err30sC%. gtr .0. (
    echo.
    echo ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^| %fbt_name%, err30 CLASSIC: start  ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|
    type fbt-run.30sC.err
    echo ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^| %fbt_name%, err30 CLASSIC: finish ^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|^|
  ) else (
    del fbt-run.30sC.err
  )
  
  echo.
  echo ###   A C H T U N G  ###  At least one of tests FAILED.
  echo.
  echo Check results in files fbt_view_results.***.log
  echo -----------------------------------------------
  fbt_view -d %~dp0fbt-run.25.trf 1>fbt_view_results.25.log 2>&1
  fbt_view -d %~dp0fbt-run.30sS.trf 1>fbt_view_results.30sS.log 2>&1
  fbt_view -d %~dp0fbt-run.30sC.trf 1>fbt_view_results.30sC.log 2>&1
  del %~dp0fbt-run.25.trf
  del %~dp0fbt-run.30sS.trf
  del %~dp0fbt-run.30sC.trf
)
cd /d %curdir%

if NOT .%overall%.==.0. pause
