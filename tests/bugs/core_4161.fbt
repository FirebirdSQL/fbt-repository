{
'id': 'bugs.core_4161',
'qmid': '',
'tracker_id': 'CORE-4161',
'title': 'User can not insert records into table with column "generated by default as identity" in its DDL',
'description': '',
'versions': [
{
 'firebird_version': '3.0',
 'platform': 'All',
 'test_type': 'ISQL',
 'init_script': 
  """
  """,
 'test_script': 
  """
    drop user tmp$core4161;
    commit;
    create user tmp$core4161 password 'tmp$core4161';
    commit;
    revoke all on all from tmp$core4161;
    commit;
    
    recreate table autoid_test(id int generated by default as identity primary key, f01 int);
    insert into autoid_test(f01) values(100);
    insert into autoid_test(f01) values(200);
    insert into autoid_test(f01) values(300);
    commit;

    recreate table backup_data(id int, f01 int);
    insert into backup_data(id, f01) select id, f01 from autoid_test;
    commit;

    grant insert,update,delete,select on autoid_test to tmp$core4161;
    grant select on backup_data to tmp$core4161;
    commit;

    show sequ;
    
    set term ^;
    execute block returns( who_am_i type of column sec$users.sec$user_name, mine_id int, mine_f01 int )
    as
      declare v_dbname type of column mon$database.mon$database_name;
      declare v_usr type of column sec$users.sec$user_name = 'tmp$core4161';
      declare v_pwd varchar(20) = 'tmp$core4161';
      declare v_connect varchar(255);
      declare v_dummy int;
    begin
      select 'localhost:' || d.mon$database_name
      from mon$database d
      into v_dbname;
    
      execute statement 'select count(*) from autoid_test'
      on external (v_dbname)
      as user (v_usr) password (v_pwd)
      into v_dummy;
    
      execute statement ('update autoid_test set f01=-f01 where id = :x') (x := 1)
      on external (v_dbname)
      as user (v_usr) password (v_pwd);
    
      execute statement ('delete from autoid_test where id >= :x') (x := 1)
      on external (v_dbname)
      as user (v_usr) password (v_pwd);
    
      execute statement ('insert into autoid_test(f01) values(:x)') (x := 555)
      on external (v_dbname)
      as user (v_usr) password (v_pwd);
    
      execute statement ('insert into autoid_test(id, f01) values(:i, :x)') (i := -1,  x := -555)
      on external (v_dbname)
      as user (v_usr) password (v_pwd);

      execute statement ('insert into autoid_test(f01) select f01 from backup_data')
      on external (v_dbname)
      as user (v_usr) password (v_pwd);
      
      for
        execute statement 'select current_user, id, f01 from autoid_test'
        on external (v_dbname)
        as user (v_usr) password (v_pwd)
        into who_am_i, mine_id, mine_f01
      do 
        suspend;
    
    end
    ^
    set term ;^
    rollback;
    
    select current_user as who_am_i, id as mine_id, f01 as mine_f01
    from autoid_test;
  """,
 'expected_stdout': 
  """
    WHO_AM_I                             MINE_ID     MINE_F01 
    =============================== ============ ============ 
    TMP$CORE4161                               4          555 
    TMP$CORE4161                              -1         -555 
    TMP$CORE4161                               5          100 
    TMP$CORE4161                               6          200 
    TMP$CORE4161                               7          300 
    
    
    WHO_AM_I                             MINE_ID     MINE_F01 
    =============================== ============ ============ 
    SYSDBA                                     1          100 
    SYSDBA                                     2          200 
    SYSDBA                                     3          300 
  """,
 'expected_stderr': 
  """
    There are no generators in this database
  """,
  'substitutions': [
    ('=.*',''),
    ('Statement failed, SQLSTATE.*',''),
    ('record not found for user:.*',''),
    ('Warning: ALL on ALL is not granted to.*', '')
  ]
}
]
}
