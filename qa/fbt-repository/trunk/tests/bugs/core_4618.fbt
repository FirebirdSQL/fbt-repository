{
'id': 'bugs.core_4618',
'qmid': None,
'tracker_id': 'CORE-4618',
'title': 'Rollback doesn`t undo changes when MERGE statement updates the same target rows multiple times and PLAN MERGE is used',
'description': '',
'min_versions': '3.0',
'versions': [
{
 'firebird_version': '3.0',
 'platform': 'All',
 'page_size': '4096',
 'init_script': 
  """
  """,
 'test_type': 'ISQL',
 'test_script': 
  """
    set term ^;
    execute block as begin
      begin execute statement 'create sequence g'; when any do begin end end
    end
    ^ set term ;^
    commit;
    alter sequence g restart with 0;
    commit;
    recreate table t(id int, x int, y int);
    commit;
    insert into t(id) select gen_id(g,1) from rdb$types rows 3;
    update t set x=mod(id,2), y=mod(id,3);
    commit;
    
    select 'before_merge' msg, t.* from t;
    
    --set plan on;
    merge into t
    using t s
    on t.x=s.x
    when matched then update set t.x = t.x+s.y, t.y = t.y - s.x;
    set plan off;
    
    select 'after_merge' msg, t.* from t;
    
    rollback;
    
    select 'after_rollback' msg, t.* from t; 

    -- ::: NB ::: Seems that trouble was NOT only because of PLAN MERGE.
    -- Compare with WI-T3.0.0.31374 Firebird 3.0 Beta 1 - here HASH also is used!
    --    MSG                    ID            X            Y 
    --    ============ ============ ============ ============ 
    --    before_merge            1            1            1 
    --    before_merge            2            0            2 
    --    before_merge            3            1            0 
    --    
    --    PLAN HASH (T NATURAL, S NATURAL)
    --    
    --    MSG                   ID            X            Y 
    --    =========== ============ ============ ============ 
    --    after_merge            1            2           -1 
    --    after_merge            2            2            2 
    --    after_merge            3            2           -2 
    --    
    --    MSG                      ID            X            Y 
    --    ============== ============ ============ ============ 
    --    after_rollback            1            2         -255 
    --    after_rollback            2            0            2 
    --    after_rollback            3            2            0 
  """,
 'expected_stdout':
  """
    MSG                    ID            X            Y 
    ============ ============ ============ ============ 
    before_merge            1            1            1 
    before_merge            2            0            2 
    before_merge            3            1            0 
    
    MSG                   ID            X            Y
    =========== ============ ============ ============ 
    after_merge            1            2            0 
    after_merge            2            2            2 
    after_merge            3            2           -1 
    
    MSG                      ID            X            Y 
    ============== ============ ============ ============ 
    after_rollback            1            1            1 
    after_rollback            2            0            2 
    after_rollback            3            1            0 
  """,
  'substitutions':[('=.*','')]
}
]
}
